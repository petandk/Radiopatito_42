// ==UserScript==
// @name        Radiopatito 42 Mobile
// @namespace   Violentmonkey Scripts
// @match       https://*.intra.42.fr/*
// @grant       GM_setValue
// @grant       GM_getValue
// @version     42.4.2-mobile
// @author      you
// @description Boooooooooooooooooooooooored - Mobile version without favorites
// ==/UserScript==

console.log('Radiopatio 42 Mobile loaded!');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒ CONFIGURACIÃ“N DE IDIOMA / LANGUAGE CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TEXTS = {
    // Botones principales / Main buttons
    MAIN_BUTTON: 'Lo mismo pero <span style="font-size: 22px;">grande</span>',
    SIDEBYSIDE_BUTTON: 'Back 2 default',
    NAVIGATION_BUTTON: 'Ir a <span style="font-size: 22px;">Clusters</span>',
    ALL_BUTTON: 'Todo 42 ğŸ†',
    CLUSTER_A_BUTTON: 'ClÃºster ğŸ…°ï¸',
    CLUSTER_B_BUTTON: 'ClÃºster ğŸ…±ï¸',

    // TÃ­tulos dinÃ¡micos / Dynamic titles
    TITLE_USERS: 'ğŸ‘¨â€ğŸ’» patitos ğŸ‘©â€ğŸ’»',
    TITLE_CLUSTER_A: ' en ClÃºster ğŸ…°ï¸',
    TITLE_CLUSTER_B: ' en ClÃºster ğŸ…±ï¸',
    TITLE_PREFIX: 'Habemos',

    // Modal de bÃºsqueda / Search modal
    SEARCH_MODAL_TITLE: 'ğŸ” Buscar Patito ğŸ”',
    SEARCH_PLACEHOLDER: 'ğŸ£ A quien coÃ±o buscas? maruha! ğŸ£',
    SEARCH_BUTTON: 'Buscar',
    SEARCH_FOUND: 'ğŸ‰ Â¡Patito encontrado! ğŸ‰',
    SEARCH_NOT_FOUND: 'âŒ Patito no encontrado âŒ',
    SEARCH_ERROR_EMPTY: 'ğŸ£ Por favor escribe un login ğŸ£',
    SEARCH_RANDOM_USER: 'ğŸ¤·â€â™‚ï¸ Usuario desconocido ğŸ¤·â€â™€ï¸',
    SEARCH_RANDOM_SUBTITLE: 'Imagen aleatoria de consolaciÃ³n',

    // Estados de usuario / User states
    USER_OFFLINE: 'ğŸ”Œ Offline ğŸ”Œ',

    // Errores / Errors
    NO_IMAGES_FOUND: 'No images found!',
    IMAGE_LOAD_ERROR: 'Image failed to load'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ§­ DETECCIÃ“N DE PÃGINA / PAGE DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const isInClustersPage = () => {
    // Debe estar en meta.intra.42.fr Y en la ruta /clusters
    return window.location.hostname === 'meta.intra.42.fr' &&
           (window.location.pathname.includes('/clusters') ||
            window.location.href.includes('/clusters'));
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”„ FUNCIONALIDAD LADO A LADO / SIDE-BY-SIDE FUNCTIONALITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sideBySideActive = false;
let originalStyles = null;

const makeTabPanesSideBySide = () => {
    if (sideBySideActive) {
        // Si ya estÃ¡ activo, revertir
        restoreOriginalLayout();
        return;
    }

    // Find the tab-content div
    const tabContent = document.querySelector('.tab-content');
    const mainContainer = document.querySelector("#main-container");

    if (!tabContent) {
        console.log('No .tab-content found');
        return;
    }

    // Store original styles for restoration
    if (!originalStyles) {
        originalStyles = {
            mainContainer: mainContainer ? mainContainer.style.display : '',
            tabPanes: []
        };
    }

    // Hide main container
    if (mainContainer) {
        mainContainer.style.display = "none";
    }

    // Find all tab-pane elements inside tab-content
    const tabPanes = tabContent.querySelectorAll('.tab-pane');
    if (tabPanes.length !== 2) {
        console.log(`Expected 2 tab panes, found ${tabPanes.length}`);
        return;
    }

    // Store original classes
    tabPanes.forEach((pane, index) => {
        originalStyles.tabPanes[index] = {
            classList: Array.from(pane.classList)
        };
        pane.classList.add('active');
    });

    // Apply CSS styles for side-by-side layout with smaller content
    const styleId = 'radiopatito-sidebyside-style';
    let existingStyle = document.getElementById(styleId);

    if (!existingStyle) {
        const style = document.createElement('style');
        style.id = styleId;
        style.textContent = `
            .tab-content {
                display: flex !important;
                gap: 10px !important; /* Reduced gap */
                height: 100vh !important; /* Full viewport height */
                overflow: hidden !important; /* Prevent page scrolling */
            }
            .tab-content .tab-pane {
                flex: 1 !important; /* Equal width for both panes */
                display: block !important; /* Override any display: none */
                opacity: 1 !important; /* Ensure visibility */
                position: relative !important;
                overflow-y: auto !important; /* Allow scrolling within pane */
                height: 100% !important;
                transform: scale(0.85) !important; /* Scale down content */
                transform-origin: top left !important;
                width: 117.647% !important; /* Compensate for scaling (1/0.85) */
            }
            /* Make first tab pane appear on the right */
            .tab-content .tab-pane:first-child {
                order: 2;
            }
            /* Make second tab pane appear on the left */
            .tab-content .tab-pane:last-child {
                order: 1;
            }
            .radiopatito-cluster-label {
                position: sticky !important;
                top: 0 !important;
                z-index: 1000 !important;
                color: #02807c !important;
                text-align: center !important;
                padding: 5px !important; /* Reduced padding */
                font-weight: bold !important;
                font-size: 14px !important; /* Smaller font */
                margin-bottom: 10px !important; /* Reduced margin */
                background: rgba(71, 75, 84, 0.9) !important; /* Semi-transparent background */
                backdrop-filter: blur(5px) !important;
            }
            /* Additional styles to make content more compact */
            .tab-content .tab-pane * {
                font-size: smaller !important;
            }
            .tab-content .tab-pane .container-fluid {
                padding: 5px !important;
            }
            .tab-content .tab-pane .row {
                margin: 2px 0 !important;
            }
            .tab-content .tab-pane .col-xs-2,
            .tab-content .tab-pane .col-sm-2,
            .tab-content .tab-pane .col-md-2,
            .tab-content .tab-pane .col-lg-2 {
                padding: 1px !important;
            }
            /* Ensure body doesn't scroll when side-by-side is active */
            body.radiopatito-sidebyside {
                overflow: hidden !important;
            }
        `;
        document.head.appendChild(style);
    }

    // Add body class to prevent scrolling
    document.body.classList.add('radiopatito-sidebyside');

    // Add cluster labels
    tabPanes.forEach((pane, index) => {
        // Remove existing labels first
        const existingLabel = pane.querySelector('.radiopatito-cluster-label');
        if (existingLabel) {
            existingLabel.remove();
        }

        // Create new label
        const label = document.createElement('div');
        label.className = 'radiopatito-cluster-label';

        // First pane (index 0) will be on the right = Cluster A
        // Second pane (index 1) will be on the left = Cluster B
        label.textContent = index === 0 ? 'ClÃºster ğŸ…°ï¸' : 'ClÃºster ğŸ…±ï¸';

        // Insert at the beginning of the pane
        pane.insertBefore(label, pane.firstChild);
    });

    sideBySideActive = true;
    console.log('Tab panes are now displayed side by side with compact layout');
};

const restoreOriginalLayout = () => {
    // Remove custom styles
    const styleElement = document.getElementById('radiopatito-sidebyside-style');
    if (styleElement) {
        styleElement.remove();
    }

    // Remove body class
    document.body.classList.remove('radiopatito-sidebyside');

    // Remove cluster labels
    document.querySelectorAll('.radiopatito-cluster-label').forEach(label => {
        label.remove();
    });

    // Restore main container
    const mainContainer = document.querySelector("#main-container");
    if (mainContainer && originalStyles) {
        mainContainer.style.display = originalStyles.mainContainer;
    }

    // Restore tab panes classes
    const tabPanes = document.querySelectorAll('.tab-content .tab-pane');
    tabPanes.forEach((pane, index) => {
        if (originalStyles && originalStyles.tabPanes[index]) {
            pane.className = ''; // Clear all classes
            originalStyles.tabPanes[index].classList.forEach(cls => {
                pane.classList.add(cls);
            });
        }
    });

    sideBySideActive = false;
    console.log('Original layout restored');
};

// Function to automatically enable side-by-side mode
const autoEnableSideBySide = () => {
    if (isInClustersPage() && !sideBySideActive) {
        const tabContent = document.querySelector('.tab-content');
        if (tabContent) {
            makeTabPanesSideBySide();
            console.log('Auto-enabled side-by-side mode');
        } else {
            // If tab-content not found, try again quickly
            setTimeout(autoEnableSideBySide, 50);
        }
    }
};

// Immediate check when script loads
if (isInClustersPage()) {
    autoEnableSideBySide();
}

// Also check when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        if (isInClustersPage()) {
            autoEnableSideBySide();
        }
    });
} else {
    // DOM is already ready
    if (isInClustersPage()) {
        autoEnableSideBySide();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ§­ FUNCIÃ“N DE NAVEGACIÃ“N / NAVIGATION FUNCTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const navigateToClusters = () => {
    window.location.href = 'https://meta.intra.42.fr/clusters';
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ FUNCIÃ“N PRINCIPAL / MAIN FUNCTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const initializeScript = () => {
    // Auto-enable side-by-side mode if on clusters page
    if (isInClustersPage()) {
        autoEnableSideBySide();
    }

    // Base button styles
    const baseButtonStyle = `
        position: fixed; right: 20px; z-index: 99999;
        background: #474b54; border: 1px solid #666; border-radius: 10px;
        color: #02807c; background-color: #D8636F; font-weight: bold;
        cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
    `;

    // Create main button
    const btn = document.createElement('button');

    // Detectar si estamos en la pÃ¡gina de clusters
    if (isInClustersPage()) {
        // Estamos en clusters - botÃ³n original
        btn.innerHTML = TEXTS.MAIN_BUTTON;
        btn.onclick = showClustersGrid;

        // Create side-by-side button (smaller, positioned above) - now for toggling
        const sideBySideBtn = document.createElement('button');
        sideBySideBtn.innerHTML = TEXTS.SIDEBYSIDE_BUTTON;
        sideBySideBtn.onclick = makeTabPanesSideBySide;

        // Style the side-by-side button (smaller size, positioned above main button)
        sideBySideBtn.style.cssText = baseButtonStyle + `
            bottom: 80px; /* Position above main button */
            padding: 5px 8px; /* Smaller padding */
            font-size: 10px; /* Smaller font size */
        `;

        // Add hover effects for side-by-side button
        sideBySideBtn.addEventListener('mouseenter', () => {
            sideBySideBtn.style.transform = 'scale(1.05)';
            sideBySideBtn.style.boxShadow = '0 4px 15px rgba(0,0,0,0.4)';
        });

        sideBySideBtn.addEventListener('mouseleave', () => {
            sideBySideBtn.style.transform = 'scale(1)';
            sideBySideBtn.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
        });

        // Add the side-by-side button to the page
        document.body.appendChild(sideBySideBtn);
    } else {
        // Estamos en otra pÃ¡gina - botÃ³n de navegaciÃ³n
        btn.innerHTML = TEXTS.NAVIGATION_BUTTON;
        btn.onclick = navigateToClusters;
    }

    // Style the main button
    btn.style.cssText = baseButtonStyle + `
        bottom: 20px;
        padding: 10px 15px;
        font-size: 14px;
    `;

    // Efectos hover para el botÃ³n principal
    btn.addEventListener('mouseenter', () => {
        btn.style.transform = 'scale(1.05)';
        btn.style.boxShadow = '0 4px 15px rgba(0,0,0,0.4)';
    });

    btn.addEventListener('mouseleave', () => {
        btn.style.transform = 'scale(1)';
        btn.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
    });

    document.body.appendChild(btn);

    // Mutation observer for dynamic content (side-by-side functionality)
    if (isInClustersPage()) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length > 0) {
                    // Check if new tab-content was added
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && (node.classList?.contains('tab-content') || node.querySelector?.('.tab-content'))) {
                            // Automatically enable side-by-side for new content immediately
                            if (!sideBySideActive) {
                                makeTabPanesSideBySide();
                            }
                        }
                    });
                }
            });
        });
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    function showClustersGrid() {
        // Find images
        const images = Array.from(document.querySelectorAll('image[*|href]')).map(img => ({
            element: img,
            href: img.getAttributeNS('http://www.w3.org/1999/xlink', 'href') ||
                  img.getAttribute('xlink:href') || img.getAttribute('href'),
            login: img.getAttribute('data-tooltip-login') || 'Unknown',
            id: img.getAttribute('id') || 'No ID',
            width: parseFloat(img.getAttribute('width')) || 50,
            height: parseFloat(img.getAttribute('height')) || 50
        })).filter(img => img.href?.trim());

        if (!images.length) {
            alert(TEXTS.NO_IMAGES_FOUND);
            return;
        }

        // Remove existing grid and modals
        document.getElementById('radiopatio-grid')?.remove();
        document.getElementById('search-modal')?.remove();
        document.querySelectorAll('[data-radiopatio-button]').forEach(btn => btn.remove());

        // State management
        let currentFilter = 'all';
        let gridContainer, titleElement, searchBtn, closeBtn;

        // Create main container
        const container = document.createElement('div');
        container.id = 'radiopatio-grid';
        container.style.cssText = `
            position: fixed; top: 10px; left: 10px; right: 10px; bottom: 10px;
            background: #474b54; border: 2px solid #666; border-radius: 10px;
            padding: 0px 20px 10px 20px; z-index: 100000; overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        `;

        // Create filter buttons container
        const filterContainer = document.createElement('div');
        filterContainer.style.cssText = `
            display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;
            position: sticky; top: 0; padding: 10px 0; z-index: 100001;
            flex-wrap: wrap;
        `;

        // Create filter buttons
        const createFilterButton = (text, filter) => {
            const button = document.createElement('button');
            button.innerHTML = text;
            button.setAttribute('data-filter', filter);
            button.style.cssText = `
                padding: 8px 16px; border: 1px solid #666; border-radius: 6px;
                font-size: 14px; font-weight: bold; cursor: pointer;
                transition: all 0.3s ease; white-space: nowrap;
                ${filter === currentFilter ?
                    'background: #D8636F; color: #02807c;' :
                    'background: #3a3e47; color: #cccccc;'}
            `;

            button.onclick = () => {
                currentFilter = filter;
                updateButtonStyles();
                updateGrid();
            };

            return button;
        };

        const todoBtn = createFilterButton(TEXTS.ALL_BUTTON, 'all');
        const clusterABtn = createFilterButton(TEXTS.CLUSTER_A_BUTTON, 'car');
        const clusterBBtn = createFilterButton(TEXTS.CLUSTER_B_BUTTON, 'cbr');

        filterContainer.appendChild(todoBtn);
        filterContainer.appendChild(clusterABtn);
        filterContainer.appendChild(clusterBBtn);

        // Update button styles based on current filter
        const updateButtonStyles = () => {
            [clusterABtn, clusterBBtn, todoBtn].forEach(btn => {
                const btnFilter = btn.getAttribute('data-filter');
                const isActive = btnFilter === currentFilter;

                if (isActive) {
                    btn.style.background = '#D8636F';
                    btn.style.color = '#02807c';
                } else {
                    btn.style.background = '#3a3e47';
                    btn.style.color = '#cccccc';
                }
            });
        };

        // Create title
        const title = document.createElement('div');
        title.style.cssText = `
            text-align: center; color: #ffffff; font-size: 18px; font-weight: bold;
            margin: 0 0 8px 0; padding: 5px 0; transition: opacity 0.3s ease;
        `;
        titleElement = title;

        // Function to update title based on filter
        const updateTitle = (filteredImages) => {
            let filterText = '';
            let emoji = TEXTS.TITLE_USERS;

            if (currentFilter === 'car') {
                filterText = TEXTS.TITLE_CLUSTER_A;
            } else if (currentFilter === 'cbr') {
                filterText = TEXTS.TITLE_CLUSTER_B;
            }

            title.textContent = `${TEXTS.TITLE_PREFIX} ${filteredImages.length} ${emoji}${filterText}`;
        };

        // Create search button
        searchBtn = document.createElement('button');
        searchBtn.textContent = 'ğŸ”';
        searchBtn.setAttribute('data-radiopatio-button', 'search');
        searchBtn.onclick = () => showSearchModal();
        searchBtn.style.cssText = `
            position: fixed; top: 15px; left: 15px; z-index: 100002;
            background: #D8636F; color: #02807c; border: none; border-radius: 50%;
            width: 40px; height: 40px; font-size: 20px; font-weight: bold; cursor: pointer;
        `;

        // Create close button
        closeBtn = document.createElement('button');
        closeBtn.textContent = 'Ã—';
        closeBtn.setAttribute('data-radiopatio-button', 'close');
        closeBtn.onclick = () => {
            container.remove();
            searchBtn.remove();
            closeBtn.remove();
            document.getElementById('search-modal')?.remove();
        };
        closeBtn.style.cssText = `
            position: fixed; top: 15px; right: 15px; z-index: 100002;
            background: #D8636F; color: #02807c; border: none; border-radius: 50%;
            width: 40px; height: 40px; font-size: 24px; font-weight: bold; cursor: pointer;
        `;

        // Hide title when scrolling
        let scrollTimeout;
        container.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                title.style.opacity = container.scrollTop > 30 ? '0' : '1';
            }, 16);
        });

        // Create image grid
        const grid = document.createElement('div');
        grid.style.cssText = `
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px; padding-top: 10px;
        `;
        gridContainer = grid;

        // Function to filter images based on current filter
        const getFilteredImages = () => {
            if (currentFilter === 'all') {
                return images;
            }
            return images.filter(imgData => imgData.id.toLowerCase().startsWith(currentFilter.toLowerCase()));
        };

        // Function to create image card
        const createImageCard = (imgData) => {
            const { href, login, id, width, height } = imgData;

            const card = document.createElement('div');
            card.className = 'radiopatio-card';
            card.style.cssText = `
                border: 1px solid #666; border-radius: 8px; padding: 15px;
                text-align: center; background: #3a3e47; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            `;

            const link = document.createElement('a');
            if (login !== 'Unknown') {
                link.href = `https://profile-v3.intra.42.fr/users/${login}`;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
            } else {
                link.href = '#';
                link.style.pointerEvents = 'none';
            }
            link.style.cssText = 'text-decoration: none; display: block;';

            const img = document.createElement('img');
            img.src = href;
            img.alt = `${login}'s profile image`;
            img.loading = 'lazy';
            img.style.cssText = `
                width: ${Math.min(width * 15, 600)}px; height: ${Math.min(height * 15, 600)}px;
                object-fit: contain; border: 2px solid #666; border-radius: 4px;
                background: #2c2f36;
            `;

            img.onerror = () => {
                img.style.display = 'none';
                const error = document.createElement('div');
                error.textContent = TEXTS.IMAGE_LOAD_ERROR;
                error.style.cssText = 'color: #ff6b6b; font-size: 14px; padding: 20px;';
                link.appendChild(error);
            };

            const info = document.createElement('div');
            info.style.cssText = 'margin-top: 10px; font-size: 12px; color: #cccccc;';
            info.innerHTML = `
                <strong style="font-size: 14px; color: #ffffff;">ğŸ‘‰ ${login} ğŸ‘ˆ</strong><br>
                <big>ğŸ–¥ï¸ ${id} ğŸ–¥ï¸</big>
            `;

            link.appendChild(img);
            card.appendChild(link);
            card.appendChild(info);
            return card;
        };

        // Function to update grid based on current filter
        const updateGrid = () => {
            gridContainer.innerHTML = '';

            const filteredImages = getFilteredImages();
            updateTitle(filteredImages);

            const fragment = document.createDocumentFragment();
            filteredImages.forEach(imgData => {
                const card = createImageCard(imgData);
                fragment.appendChild(card);
            });
            gridContainer.appendChild(fragment);

            console.log(`Radiopatio 42: Updated grid with ${filteredImages.length} images (filter: ${currentFilter})`);
        };

        // Function to show search modal
        const showSearchModal = () => {
            document.getElementById('search-modal')?.remove();

            const searchModal = document.createElement('div');
            searchModal.id = 'search-modal';
            searchModal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); z-index: 100003;
                display: flex; align-items: center; justify-content: center;
            `;

            const searchContent = document.createElement('div');
            searchContent.style.cssText = `
                background: #474b54; border: 2px solid #666; border-radius: 10px;
                padding: 30px; width: 400px; max-width: 90vw; position: relative;
                box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            `;

            const searchTitle = document.createElement('h3');
            searchTitle.textContent = TEXTS.SEARCH_MODAL_TITLE;
            searchTitle.style.cssText = `
                color: #ffffff; text-align: center; margin: 0 0 20px 0;
                font-size: 18px;
            `;

            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = TEXTS.SEARCH_PLACEHOLDER;
            searchInput.style.cssText = `
                width: 100%; padding: 12px; border: 1px solid #666;
                border-radius: 6px; background: #3a3e47; color: #ffffff;
                font-size: 16px; box-sizing: border-box;
            `;

            const searchButton = document.createElement('button');
            searchButton.textContent = TEXTS.SEARCH_BUTTON;
            searchButton.style.cssText = `
                width: 100%; margin-top: 15px; padding: 12px;
                background: #D8636F; color: #02807c; border: none;
                border-radius: 6px; font-size: 16px; font-weight: bold;
                cursor: pointer;
            `;

            const resultDiv = document.createElement('div');
            resultDiv.style.cssText = 'margin-top: 20px;';

            const performSearch = () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                if (!searchTerm) {
                    resultDiv.innerHTML = `<div style="color: #ff6b6b; text-align: center;">${TEXTS.SEARCH_ERROR_EMPTY}</div>`;
                    return;
                }

                resultDiv.innerHTML = '';

                const foundUser = images.find(img =>
                    img.login.toLowerCase() === searchTerm
                );

                if (foundUser) {
                    const userCard = createImageCard(foundUser);
                    userCard.style.cssText += ' margin: 0 auto; max-width: 300px;';

                    const foundText = document.createElement('div');
                    foundText.textContent = TEXTS.SEARCH_FOUND;
                    foundText.style.cssText = `
                        color: #4ade80; text-align: center; margin-bottom: 15px;
                        font-weight: bold; font-size: 16px;
                    `;

                    resultDiv.appendChild(foundText);
                    resultDiv.appendChild(userCard);
                } else {
                    const notFoundText = document.createElement('div');
                    notFoundText.textContent = TEXTS.SEARCH_NOT_FOUND;
                    notFoundText.style.cssText = `
                        color: #ff6b6b; text-align: center; margin-bottom: 15px;
                        font-weight: bold; font-size: 16px;
                    `;

                    const randomImageCard = document.createElement('div');
                    randomImageCard.style.cssText = `
                        border: 1px solid #666; border-radius: 8px; padding: 15px;
                        text-align: center; background: #3a3e47; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        margin: 0 auto; max-width: 250px;
                    `;

                    const randomImg = document.createElement('img');
                    randomImg.src = `https://picsum.photos/200?random=${Date.now()}`;
                    randomImg.alt = 'Random image';
                    randomImg.loading = 'lazy';
                    randomImg.style.cssText = `
                        width: 200px; height: 200px; object-fit: cover;
                        border: 2px solid #666; border-radius: 4px;
                    `;

                    const randomInfo = document.createElement('div');
                    randomInfo.style.cssText = 'margin-top: 10px; font-size: 14px; color: #cccccc;';
                    randomInfo.innerHTML = `
                        <strong style="color: #ffffff;">${TEXTS.SEARCH_RANDOM_USER}</strong><br>
                        <em>${TEXTS.SEARCH_RANDOM_SUBTITLE}</em>
                    `;

                    randomImageCard.appendChild(randomImg);
                    randomImageCard.appendChild(randomInfo);

                    resultDiv.appendChild(notFoundText);
                    resultDiv.appendChild(randomImageCard);
                }
            };

            const closeSearchModal = () => {
                searchModal.remove();
            };

            searchButton.onclick = performSearch;
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                }
            });

            searchModal.addEventListener('click', (e) => {
                if (e.target === searchModal) {
                    closeSearchModal();
                }
            });

            const closeSearchBtn = document.createElement('button');
            closeSearchBtn.textContent = 'Ã—';
            closeSearchBtn.onclick = closeSearchModal;
            closeSearchBtn.style.cssText = `
                position: absolute; top: 10px; right: 15px;
                background: none; border: none; color: #cccccc;
                font-size: 24px; cursor: pointer; padding: 0;
            `;

            const handleKeydown = (e) => {
                if (e.key === 'Escape') {
                    closeSearchModal();
                    document.removeEventListener('keydown', handleKeydown);
                }
            };
            document.addEventListener('keydown', handleKeydown);

            searchContent.appendChild(closeSearchBtn);
            searchContent.appendChild(searchTitle);
            searchContent.appendChild(searchInput);
            searchContent.appendChild(searchButton);
            searchContent.appendChild(resultDiv);
            searchModal.appendChild(searchContent);
            document.body.appendChild(searchModal);

            setTimeout(() => {
                searchInput.focus();
                searchInput.select();
            }, 100);
        };

        // Build initial UI
        container.appendChild(filterContainer);
        container.appendChild(title);
        container.appendChild(grid);
        document.body.appendChild(container);
        document.body.appendChild(closeBtn);
        document.body.appendChild(searchBtn);

        // Initialize with all images
        updateGrid();

        console.log(`Radiopatio 42: Initialized with ${images.length} total images`);
    }
};

// Initialize the script immediately
initializeScript();

// Also run when DOM is fully loaded as backup
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeScript);
} else {
    // DOM is already ready, run a quick check
    setTimeout(initializeScript, 100);
}
